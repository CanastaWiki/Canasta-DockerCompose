input {
  file {
    path => "/var/log/mediawiki/*.log"
    start_position => "beginning"
    sincedb_path => "/usr/share/logstash/data/sincedb/mediawiki"
    type => "mediawiki"
  }
}

filter {
  if [type] == "mediawiki" {
    # Add source file name as a field
    mutate {
      add_field => { "log_type" => "%{path}" }
    }

    # Try to parse as JSON if the log line looks like JSON
    if [message] =~ /^\{.*\}$/ {
      json {
        source => "message"
        target => "parsed"
      }
    }

    # Extract timestamp if present in standard MediaWiki format
    grok {
      match => { "message" => "^\[%{TIMESTAMP_ISO8601:log_timestamp}\]" }
      tag_on_failure => []
    }
    if [log_timestamp] {
      date {
        match => ["log_timestamp", "ISO8601"]
        target => "@timestamp"
      }
    }

    # Add application identifier
    mutate {
      add_field => { "application" => "mediawiki" }
    }
  }
}

output {
  if [type] == "mediawiki" {
    opensearch {
      hosts => ["http://opensearch:9200"]
      index => "mediawiki-logs-%{+YYYY.MM.dd}"
    }
  }
}
